# 单个订单重新检查功能

## 更新日期
2026年2月7日

## 新增功能

### 🔄 单订单重新检查按钮

每条查询结果现在都有一个 **"🔄 检查"** 按钮，可以单独重新查询该订单。

## 使用场景

### 适用情况

1. ✅ **订单信息显示为 `-`（横线）**
   - 订单号、产品名称等字段显示不全
   - 需要重新查询获取完整信息

2. ✅ **查询失败的订单**
   - 显示"查询失败"的红色标记
   - 可以单独重试而不影响其他订单

3. ✅ **SHIPPED 订单缺少物流单号**
   - 状态是 Shipped 但物流单号显示"-"
   - 重新检查获取最新物流信息

4. ✅ **验证订单状态更新**
   - 订单状态可能已经变化
   - 快速验证最新状态

## 功能特点

### 1️⃣ **智能重试机制**

点击"检查"按钮后：
- 自动重试 **2次**（如果失败）
- 每次重试间隔 1 秒
- 最多 3 次查询机会

### 2️⃣ **实时状态显示**

检查过程中的状态变化：

```
原始状态 → 🔄 检查中... → 最新结果
```

**按钮状态：**
- 点击前：`🔄 检查`
- 检查中：`⏳ 检查中`（按钮禁用）
- 完成后：`🔄 检查`（按钮恢复）

**订单状态：**
- 检查中：黄色标记 `🔄 检查中...`
- 成功后：显示实际状态（Shipped、Processing 等）
- 失败后：红色标记 `查询失败`

### 3️⃣ **无需重新查询全部**

- ✅ 只查询选中的单个订单
- ✅ 不影响其他订单结果
- ✅ 保持表格排序和位置
- ✅ 自动更新统计数据

### 4️⃣ **数据实时更新**

检查完成后自动更新：
- 表格行数据
- 统计信息
- CSV 导出数据

## 使用方法

### 步骤1：批量查询订单

1. 访问：http://localhost:8080/query
2. 输入订单链接
3. 点击"开始查询"
4. 等待查询完成

### 步骤2：识别需要检查的订单

查看查询结果，找到需要重新检查的订单：

| 情况 | 表现 | 操作 |
|------|------|------|
| 信息不完整 | 订单号、产品等显示 `-` | 点击"检查" |
| 查询失败 | 红色"查询失败"标记 | 点击"检查" |
| 缺少物流单号 | SHIPPED 但物流单号为 `-` | 点击"检查" |

### 步骤3：点击检查按钮

找到对应订单行，点击右侧的 **"🔄 检查"** 按钮

### 步骤4：等待检查完成

- 按钮变为 `⏳ 检查中`
- 订单状态显示 `🔄 检查中...`
- 等待 5-30 秒（取决于网络速度）

### 步骤5：查看更新结果

检查完成后：
- ✅ 表格自动更新最新数据
- ✅ 统计数据自动刷新
- ✅ 可以导出最新的 CSV

## 界面展示

### 查询结果表格

```
┌────┬──────┬────────┬──────┬────────┬──────────┬────────┬──────────┬────────┐
│序号│链接  │订单状态 │订单号│下单日期 │购买设备   │预计送达│物流单号   │操作    │
├────┼──────┼────────┼──────┼────────┼──────────┼────────┼──────────┼────────┤
│ 1  │ ... │Shipped │W1234 │Dec 23  │iPhone 17 │Feb 10  │1ZA828Y...│🔄 检查 │
├────┼──────┼────────┼──────┼────────┼──────────┼────────┼──────────┼────────┤
│ 2  │ ... │Shipped │W1470 │Dec 29  │iPhone 17 │Feb 10  │1ZA827V...│🔄 检查 │
├────┼──────┼────────┼──────┼────────┼──────────┼────────┼──────────┼────────┤
│ 3  │ ... │   -    │  -   │   -    │    -     │   -    │    -     │🔄 检查 │ ← 需要检查
├────┼──────┼────────┼──────┼────────┼──────────┼────────┼──────────┼────────┤
│ 4  │ ... │   -    │  -   │   -    │    -     │   -    │    -     │🔄 检查 │ ← 需要检查
└────┴──────┴────────┴──────┴────────┴──────────┴────────┴──────────┴────────┘
```

### 检查中状态

```
┌────┬──────┬─────────────┬──────┬────────┬──────────┬────────┬──────────┬──────────┐
│序号│链接  │订单状态      │订单号│下单日期 │购买设备   │预计送达│物流单号   │操作      │
├────┼──────┼─────────────┼──────┼────────┼──────────┼────────┼──────────┼──────────┤
│ 3  │ ... │🔄 检查中...  │  -   │   -    │    -     │   -    │    -     │⏳检查中  │
└────┴──────┴─────────────┴──────┴────────┴──────────┴────────┴──────────┴──────────┘
```

### 检查完成

```
┌────┬──────┬────────┬──────┬────────┬──────────┬────────┬──────────┬────────┐
│序号│链接  │订单状态 │订单号│下单日期 │购买设备   │预计送达│物流单号   │操作    │
├────┼──────┼────────┼──────┼────────┼──────────┼────────┼──────────┼────────┤
│ 3  │ ... │Shipped │W1420 │Dec 18  │iPhone 17 │Feb 10  │1ZA827V...│🔄 检查 │ ✅ 已更新
└────┴──────┴────────┴──────┴────────┴──────────┴────────┴──────────┴────────┘
```

## 技术实现

### 工作流程

```javascript
用户点击"检查"按钮
    ↓
1. 禁用按钮，显示"⏳ 检查中"
2. 订单状态改为"🔄 检查中..."
    ↓
3. 调用 queryOrderWithRetry() 函数
   ├─ 尝试查询 (1/3)
   ├─ 失败？重试 (2/3)
   └─ 失败？再重试 (3/3)
    ↓
4. 获取最新结果
    ↓
5. 移除旧的表格行
6. 插入新的表格行
7. 更新全局结果数组
8. 刷新统计数据
    ↓
完成 ✅
```

### 核心函数

```javascript
async function recheckOrder(index, url) {
    // 1. 找到对应的行
    const row = document.getElementById(`row-${index + 1}`);
    
    // 2. 显示检查中状态
    cells[2].innerHTML = '🔄 检查中...';
    btn.disabled = true;
    
    // 3. 调用查询（带重试）
    const result = await queryOrderWithRetry(url, timeout, 2);
    
    // 4. 更新结果
    queryResults[index] = result;
    
    // 5. 重新渲染这一行
    row.remove();
    addResultToTable(result, index + 1);
    
    // 6. 更新统计
    updateStats();
}
```

## 常见问题

### Q1：点击检查按钮没反应？

**可能原因：**
- 按钮被禁用（正在检查中）
- JavaScript 错误
- 网络问题

**解决方案：**
1. 等待当前检查完成
2. 刷新页面后重试
3. 检查浏览器控制台（F12）查看错误

### Q2：检查后仍然显示"-"？

**可能原因：**
1. 订单链接无效
2. 网络连接问题
3. 苹果服务器响应慢
4. 订单信息确实为空

**解决方案：**
- 手动访问订单链接验证
- 再次点击检查按钮
- 检查网络连接
- 等待一段时间后重试

### Q3：检查需要多长时间？

**正常情况：**
- 成功：5-15 秒
- 重试 1 次：15-30 秒
- 重试 2 次：30-45 秒

**超时：**
- 默认超时：30 秒
- 可在设置中调整（30-90 秒）

### Q4：可以同时检查多个订单吗？

**当前版本：**
- ❌ 不支持同时检查多个
- 需要逐个点击检查按钮

**建议：**
- 先检查最重要的订单
- 或者重新批量查询所有订单

## 性能优化

### 优化建议

1. **批量检查**
   - 如果有很多订单需要检查
   - 建议使用"开始查询"重新查询全部
   - 而不是逐个点击检查

2. **合理设置超时**
   - 网络快：30 秒
   - 网络慢：60 秒
   - 特殊情况：90 秒

3. **避免频繁检查**
   - 同一订单不要连续多次检查
   - 建议间隔至少 1-2 分钟

## 数据一致性

### 自动更新

检查完成后会自动更新：

1. ✅ **表格数据**：实时显示最新信息
2. ✅ **统计数据**：更新成功/失败/已发货数量
3. ✅ **导出数据**：CSV 导出包含最新数据
4. ✅ **结果数组**：内存中的结果数组同步更新

### 数据持久化

⚠️ **注意：**
- 检查结果仅保存在当前页面
- 刷新页面后会丢失
- 建议检查后立即导出 CSV

## 使用技巧

### 技巧1：批量识别需要检查的订单

快速找到显示"-"的订单：
1. 查看"订单号"列
2. 找到显示"-"的行
3. 逐个点击"检查"按钮

### 技巧2：优先检查重要订单

建议检查顺序：
1. 已发货但缺少物流单号的
2. 查询失败的
3. 信息不完整的

### 技巧3：查看控制台日志

打开控制台（F12）可以看到：
```
✅ 订单 W1234567890 重新检查成功
❌ 订单重新检查失败: timeout
```

### 技巧4：导出前检查

在导出 CSV 之前：
1. 检查所有显示"-"的订单
2. 确保数据完整
3. 然后点击"导出 CSV"

## 更新日志

- **2026-02-07**: 新增单订单检查功能
  - ✅ 每行添加"检查"按钮
  - ✅ 支持单独重新查询
  - ✅ 实时状态显示
  - ✅ 自动更新表格和统计
  - ✅ 智能重试机制

---

🎉 立即体验单订单检查功能！
访问：http://localhost:8080/query
