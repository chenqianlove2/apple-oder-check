# 🚨 首次查询取消订单通知功能

## ✨ 功能说明

当监控系统**首次查询**一个订单时，如果发现订单状态是 **CANCELED（已取消）**，会立即发送紧急通知！

---

## 📋 工作原理

### 正常流程
```
第一次查询 → 状态: PROCESSING → 保存状态（不通知）
第二次查询 → 状态: SHIPPED → 检测到变更 → 发送通知 ✅
第三次查询 → 状态: DELIVERED → 检测到变更 → 发送通知 ✅
```

### 特殊情况：首次就是取消状态
```
第一次查询 → 状态: CANCELED → 🚨 立即发送紧急通知！
```

---

## 🎯 应用场景

### 场景 1：新添加的订单已被取消
```
客户：我刚下了一个订单，帮我加到监控里
你：好的，添加...
系统：🚨🚨 【重要警告：订单已取消】 🚨🚨
```
立即知道这个订单有问题！

### 场景 2：补充历史订单
```
你添加了一批老订单到监控系统
其中一个订单早就被取消了
系统：🚨 首次查询发现订单已取消
```
不会错过任何取消的订单！

### 场景 3：数据丢失后重建
```
系统数据丢失，重新添加所有订单
某些订单在数据丢失期间被取消
系统：🚨 逐一通知所有取消的订单
```
确保不会漏掉取消通知！

---

## 📱 通知样式

### 首次查询到取消状态
```
🚨🚨 【重要警告：订单已取消】 🚨🚨

❌ 苹果订单状态变更

订单号: W1234567890
产品: iPhone 15 Pro Max 256GB
下单日期: 2026-01-15

状态变更:
⚠️ 首次查询发现 → ❌ Canceled

预计送达: -

检测时间: 2026-02-08 14:30:00

🔗 查看订单详情
```

### 状态变更为取消（非首次）
```
🚨 【订单已取消】

❌ 苹果订单状态变更

订单号: W1234567890
产品: iPhone 15 Pro Max 256GB
下单日期: 2026-01-15

状态变更:
⏳ Processing → ❌ Canceled

预计送达: -

检测时间: 2026-02-08 14:30:00

🔗 查看订单详情
```

---

## 🔧 技术实现

### monitor.py（后台监控）
```python
# 判断是否首次查询
is_first_check = url not in self.order_history

# 首次查询到取消状态 - 立即通知
if is_first_check and new_status in ['CANCELED', 'CANCELLED']:
    should_send = True
    print(f"⚠️  首次查询发现订单已取消: {result.get('orderNumber')}")
    self.send_status_notification(result, '首次查询')
```

### web_monitor.py（Web 监控）
```python
# 第一次查询该订单
if result.get('success') and result.get('status') == 'CANCELED':
    print(f"🚨 首次查询订单 {result.get('orderNumber')}，状态: CANCELED，发送通知")
    notifier.send_order_notification(result, None)
```

### notifier.py（通知发送）
```python
# 识别首次查询
is_first_check = old_status is None or old_status == '首次查询'

if is_first_check:
    if status == 'CANCELED':
        # 首次查询就是取消状态 - 特殊提示
        old_status_display = '⚠️ 首次查询发现'
        urgent_header = '🚨🚨 【重要警告：订单已取消】 🚨🚨\n\n'
```

---

## 🧪 测试方法

### 方法 1：使用测试脚本
```bash
python3 test_first_cancel_notification.py
```

这会发送三种不同场景的测试通知到您的 Telegram。

### 方法 2：手动测试
1. 找一个已取消的订单链接
2. 确保这个订单**不在**监控历史中（删除 `order_history.json` 或移除该订单）
3. 添加到监控系统
4. 立即触发检查
5. 应该收到紧急通知

### 方法 3：Web 界面测试
1. 访问 http://127.0.0.1:8846/
2. 在 "📋 订单列表" 中添加一个已取消的订单
3. 点击 "🔍 立即检查"
4. 检查 Telegram 是否收到通知

---

## ⚙️ 配置选项

目前此功能**默认启用**，无需额外配置。

如果需要，可以在 `monitor_config.json` 中调整：
```json
{
  "notify_on_cancel": true,  // 取消时通知（包括首次查询）
  "notify_all_changes": true  // 所有状态变更都通知
}
```

---

## 💡 最佳实践

### ✅ 推荐做法

1. **定期检查取消订单**
   - 收到首次取消通知时，立即核实原因
   - 联系客户确认是否需要重新下单

2. **保留监控历史**
   - 不要随意删除 `order_history.json`
   - 这样可以准确追踪状态变更

3. **添加订单时备注**
   - 在 `orders.txt` 中添加注释
   ```
   # 客户 A 的订单 - 2026-02-08
   https://www.apple.com/xc/us/vieworder/W1234567890/email@example.com
   ```

4. **配置多个机器人**
   - 重要订单的取消通知发送到多个群
   - 确保不会错过

### ⚠️ 注意事项

1. **首次查询不会通知所有订单**
   - 只有首次查询就是 CANCELED 的才会通知
   - 其他状态（PROCESSING、SHIPPED 等）不会在首次查询时通知

2. **已完成的订单**
   - DELIVERED（已送达）状态不会重复查询
   - 添加到监控后会检查一次，然后跳过

3. **网络问题**
   - 如果首次查询失败，不会发送通知
   - 下次查询成功后会作为"首次"处理

---

## 🔄 与其他功能的配合

### 多 Telegram 机器人
```
首次取消通知 + 多机器人 = 多个群同时收到紧急警告！
```

### 自动监控
```
添加订单 → 自动后台检查 → 发现取消 → 立即通知
无需手动触发，全自动化！
```

### Web 界面
```
添加订单 → 点击"立即检查" → 实时查看结果 → 同时收到 Telegram 通知
```

---

## 📊 统计与日志

### 控制台输出
```bash
⚠️  首次查询发现订单已取消: W1234567890
🚨 首次查询订单 W1234567890，状态: CANCELED，发送通知
✅ 成功发送到 2/2 个机器人
```

### 状态变更记录
在 `order_history.json` 中：
```json
{
  "changes": [
    {
      "url": "...",
      "orderNumber": "W1234567890",
      "productName": "iPhone 15 Pro Max",
      "oldStatus": null,
      "newStatus": "CANCELED",
      "timestamp": "2026-02-08T14:30:00"
    }
  ]
}
```

---

## ❓ 常见问题

### Q1: 为什么首次查询其他状态不通知？
**A**: 因为首次查询通常是"正常"的初始状态（如 PROCESSING），不需要提醒。只有取消状态是"异常"的，需要立即知道。

### Q2: 如果首次查询失败怎么办？
**A**: 下次查询成功后仍会被识别为"首次"，如果是取消状态仍会通知。

### Q3: 已经收到过通知的订单还会再通知吗？
**A**: 不会。同一个订单同一个状态只通知一次。除非状态又变更了。

### Q4: 可以关闭这个功能吗？
**A**: 目前不建议关闭。这是为了防止遗漏重要的取消通知。如果确实需要，可以修改代码。

---

## 🚀 开始使用

1. 确保已配置 Telegram 机器人
2. 添加订单到监控系统
3. 系统会自动检测首次查询的取消订单
4. 立即收到紧急通知！

简单、自动、可靠！ 😊
