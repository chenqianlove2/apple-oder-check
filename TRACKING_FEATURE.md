# 物流追踪功能更新说明

## 更新日期
2026年2月7日

## 新增功能
✅ **物流追踪链接显示** - 当订单状态为 SHIPPED（已发货）时，自动提取并显示 UPS 物流追踪链接

## 修改的文件

### 1. web_monitor.py
- 在 `query_order()` 函数中添加了 `trackingUrl` 字段
- 从订单页面 HTML 中提取物流追踪链接
- 支持两种提取方式：
  1. 从 JSON 数据中提取 `"trackingUrl"` 字段
  2. 使用正则表达式匹配 UPS 追踪链接

### 2. web_server.py（监控页面）
- **订单列表显示**：为 SHIPPED 状态的订单添加 "🚚 追踪物流" 按钮
- 点击按钮在新标签页打开 UPS 物流追踪页面

### 3. web_server.py（批量查询页面）
- **表格列**：添加了 "物流追踪" 列
- **显示逻辑**：SHIPPED 状态订单显示可点击的追踪链接
- **CSV 导出**：导出数据时包含物流追踪链接

### 4. notifier.py
- **Telegram 通知**：当订单状态变更为 SHIPPED 时，通知消息中包含物流追踪链接
- 格式：`🚚 物流追踪: [点击追踪包裹](tracking_url)`

## 功能展示

### 监控页面
```
订单列表显示：
┌─────────────────────────────────────┐
│ W1234567890                        │
│ iPhone 15 Pro                      │
│ ✅ Shipped                         │
│ [检查] [🚚 追踪物流] [删除]         │
└─────────────────────────────────────┘
```

### 批量查询页面
```
表格显示：
┌────┬─────┬────────┬──────┬────────┬──────────┬────────┬────────┐
│序号│链接 │订单状态 │订单号│下单日期 │购买设备   │预计送达│物流追踪│
├────┼─────┼────────┼──────┼────────┼──────────┼────────┼────────┤
│ 1  │ ... │Shipped │W1234 │2026-02 │iPhone 15 │2026-02│🚚 追踪 │
└────┴─────┴────────┴──────┴────────┴──────────┴────────┴────────┘
```

### Telegram 通知
```
🚚 苹果订单状态变更

订单号: W1234567890
产品: iPhone 15 Pro
下单日期: 2026-02-01

状态变更:
📦 Preparing to Ship → 🚚 Shipped

预计送达: 2026-02-10

🚚 物流追踪: [点击追踪包裹]

检测时间: 2026-02-07 12:00:00

[🔗 查看订单详情]
```

## 使用说明

### 自动提取
当监控系统检测订单时，会自动尝试提取物流追踪链接：
1. 订单状态变更为 SHIPPED
2. 系统从苹果订单页面提取 UPS 追踪链接
3. 链接格式：`http://wwwapps.ups.com/etracking/tracking.cgi?...`

### 手动查看
在监控页面中：
1. 找到状态为 "Shipped" 的订单
2. 点击 "🚚 追踪物流" 按钮
3. 自动在新窗口打开 UPS 物流追踪页面

### 注意事项
⚠️ **重要提示**：
- 物流追踪链接仅在订单状态为 SHIPPED 时可用
- 如果苹果订单页面未提供追踪链接，则显示为 "-"
- 追踪链接通常在订单发货后 24 小时内生效

## 技术细节

### 提取规则
```python
# 方法1：从 JSON 数据提取
m = re.search(r'"trackingUrl"\s*:\s*"([^"]+)"', html)

# 方法2：直接匹配 UPS 链接
m = re.search(r'(https?://[^"\s]+ups\.com[^"\s]+)', html)
```

### 数据结构
```python
result = {
    'orderNumber': 'W1234567890',
    'status': 'SHIPPED',
    'trackingUrl': 'http://wwwapps.ups.com/etracking/...',
    # ... 其他字段
}
```

## 测试
运行测试脚本验证功能：
```bash
python3 test_tracking.py
```

## 后续优化建议
1. 支持更多物流公司（FedEx, DHL 等）
2. 实时物流状态更新
3. 物流轨迹可视化
4. 配送延迟预警

---
📝 更新完成！如有问题请及时反馈。
