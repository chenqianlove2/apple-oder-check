# 批量查询物流显示优化

## 更新日期
2026年2月7日

## 新增功能

### 📊 智能物流查询显示

批量查询现在会清晰地显示查询过程和物流信息：

#### 1️⃣ **查询过程分步显示**

**第一步：查询订单状态**
```
正在查询订单状态 50/100
速度: 3.5 个/秒
```

**第二步：检测已发货订单**
```
检测到 15 个已发货订单缺少物流单号，正在查询...
```

**第三步：重试失败订单**（如有）
```
第一轮完成，重试 5 个失败的订单...
```

**第四步：最终结果**
```
查询完成，共 100 条，成功 95 条，失败 5 条，已发货 15 条（含物流单号 12 条），耗时 45.3 秒
```

#### 2️⃣ **物流单号智能显示**

表格中的物流单号列会根据状态显示不同内容：

| 订单状态 | 物流单号显示 | 说明 |
|---------|------------|------|
| PLACED | - | 订单已下单，无物流信息 |
| PROCESSING | - | 订单处理中，无物流信息 |
| PREPARED_FOR_SHIPMENT | - | 准备发货，无物流信息 |
| SHIPPED（有单号） | <span style="color:green">1ZA828Y90268769346</span> | 绿色显示物流单号 |
| SHIPPED（无单号） | <span style="color:gray">查询中...</span> | 灰色显示查询状态 |
| DELIVERED | 物流单号（如有） | 已送达 |

#### 3️⃣ **控制台详细日志**

打开浏览器控制台（F12）可以看到：

```javascript
发现 15 个 SHIPPED 订单需要查询物流单号
订单 W1342476105: 物流单号 1ZA828Y90268769346
订单 W1420756933: 物流单号 1ZA8272V0242551171
订单 W1470730058: 物流单号 1ZA8272V0242850820
...
```

## 查询流程详解

### 完整流程图

```
开始批量查询
    ↓
第一阶段：查询所有订单基本信息
├─ 订单号
├─ 产品名称
├─ 订单状态 ← 重点
├─ 下单日期
├─ 预计送达
└─ 物流追踪链接（如果有）
    ↓
第二阶段：分析订单状态
├─ 识别 SHIPPED 状态订单
├─ 从追踪链接提取物流单号
└─ 显示物流查询统计
    ↓
第三阶段：重试失败订单（如有）
└─ 对失败的订单再次查询
    ↓
第四阶段：显示最终结果
├─ 总数统计
├─ 成功/失败统计
├─ 已发货统计
└─ 物流单号获取率
```

### 实际案例

**输入：100 个订单**

```
查询结果分布：
├─ PLACED: 20 个（无物流）
├─ PROCESSING: 30 个（无物流）
├─ PREPARED_FOR_SHIPMENT: 15 个（无物流）
├─ SHIPPED: 25 个
│   ├─ 有物流单号: 20 个 ✅
│   └─ 无物流单号: 5 个（可能是刚发货）
├─ DELIVERED: 8 个
└─ 失败: 2 个 ❌

最终显示：
"查询完成，共 100 条，成功 98 条，失败 2 条，
已发货 25 条（含物流单号 20 条），耗时 45.3 秒"
```

## 状态显示对照表

### 查询状态图标和颜色

| 状态 | 显示 | 颜色 | 含义 |
|-----|------|------|------|
| Order Placed | 📝 | 灰色 | 订单已下单 |
| Processing | ⏳ | 黄色 | 处理中 |
| Preparing to Ship | 📦 | 黄色 | 准备发货 |
| **Shipped** | 🚚 | 蓝色 | **已发货（查询物流）** |
| Delivered | ✅ | 绿色 | 已送达 |
| Canceled | ❌ | 红色 | 已取消 |
| 查询失败 | ⚠️ | 红色 | 查询出错 |

### 物流单号显示

```html
<!-- SHIPPED 状态且有物流单号 -->
<td><span style="color:#28a745;">1ZA828Y90268769346</span></td>

<!-- SHIPPED 状态但无物流单号 -->
<td><span style="color:#999;">查询中...</span></td>

<!-- 其他状态 -->
<td>-</td>
```

## 使用方法

### 1. 访问批量查询页面
http://localhost:8080/query

### 2. 输入订单链接
```
https://www.apple.com/xc/us/vieworder/W1234567890/email1@example.com
https://www.apple.com/xc/us/vieworder/W0987654321/email2@example.com
...
```

### 3. 点击"开始查询"

### 4. 观察查询过程
- **进度条**：显示总体进度
- **状态栏**：显示当前阶段
  - "正在查询订单状态 50/100"
  - "检测到 15 个已发货订单..."
  - "第一轮完成，重试 5 个失败的订单..."
- **速度显示**：实时查询速度

### 5. 查看结果
- **表格**：查看每个订单的详细信息
- **统计**：查看总体统计数据
- **物流单号**：SHIPPED 订单的物流单号以绿色显示

## 数据导出

### CSV 导出内容

导出的 CSV 文件包含以下列：

```
序号,链接,状态,订单号,下单日期,产品,预计送达,物流单号
1,"https://...","SHIPPED","W1234567890","2026-02-01","iPhone 15 Pro","2026-02-10","1ZA828Y90268769346"
2,"https://...","PROCESSING","W0987654321","2026-02-02","iPad Pro","2026-02-15","-"
```

### 导出特点

✅ **包含物流单号列**
✅ **UTF-8 编码，Excel 可直接打开**
✅ **自动过滤失败的订单**
✅ **按查询顺序排列**

## 性能优化

### 查询策略

1. **并发查询**：多线程同时查询，提高速度
2. **一次性提取**：订单信息和物流单号同时提取
3. **智能重试**：失败订单自动重试 2 次
4. **状态分析**：自动识别 SHIPPED 状态

### 速度对比

| 订单数量 | 并发数 | 预计时间 |
|---------|--------|---------|
| 10 个 | 5 | 6-10 秒 |
| 50 个 | 10 | 20-30 秒 |
| 100 个 | 10 | 40-60 秒 |
| 500 个 | 10 | 3-5 分钟 |

*注：实际时间取决于网络速度和苹果服务器响应速度*

## 技术实现

### 前端逻辑

```javascript
// 1. 查询订单基本信息
for (let url of urls) {
    result = await queryOrder(url);
    
    // 2. 检查是否为 SHIPPED 状态
    if (result.status === 'SHIPPED') {
        // 物流单号已在第一次查询时提取
        if (result.trackingNumber) {
            // 显示为绿色
        } else {
            // 显示"查询中..."
        }
    }
}

// 3. 统计并显示结果
显示总数、成功数、失败数、已发货数、物流单号获取数
```

### 后端逻辑

```python
def query_order(url):
    # 1. 获取订单页面 HTML
    html = requests.get(url)
    
    # 2. 提取基本信息
    extract_order_number()
    extract_product_name()
    extract_status()  # ← 关键
    
    # 3. 如果状态是 SHIPPED，提取物流信息
    if status == 'SHIPPED':
        extract_tracking_url()
        extract_tracking_number()
    
    return result
```

## 故障排查

### 问题1：物流单号显示"-"

**可能原因：**
1. 订单刚发货，物流单号还未生成
2. 苹果页面未提供物流追踪链接
3. 物流单号格式不匹配

**解决方案：**
- 等待几小时后重新查询
- 手动访问订单页面确认
- 检查控制台日志

### 问题2：大量订单失败

**可能原因：**
1. 网络连接问题
2. 苹果服务器限流
3. 订单链接格式错误

**解决方案：**
- 检查网络连接
- 减少并发数（改为 3-5）
- 增加超时时间（改为 60-90 秒）
- 分批查询

### 问题3：查询速度很慢

**可能原因：**
1. 并发数设置太低
2. 超时时间设置太长
3. 网络速度慢

**解决方案：**
- 增加并发数（改为 10-15）
- 适当减少超时时间
- 使用更快的网络

## 注意事项

⚠️ **重要提示：**

1. **物流单号时效性**
   - 订单刚发货时可能没有物流单号
   - 建议发货后 2-24 小时再查询

2. **查询频率**
   - 不要频繁查询同一批订单
   - 建议间隔至少 5-10 分钟

3. **数据准确性**
   - 以苹果官网显示为准
   - 物流单号可能会更新

4. **隐私保护**
   - 不要分享订单链接
   - 及时导出后删除敏感数据

## 更新日志

- **2026-02-07**: 优化物流显示
  - ✅ 分步显示查询过程
  - ✅ 智能识别 SHIPPED 状态
  - ✅ 物流单号绿色高亮显示
  - ✅ 添加物流统计信息
  - ✅ 优化最终结果展示

---

🎉 现在就可以体验优化后的批量查询功能了！
访问：http://localhost:8080/query
