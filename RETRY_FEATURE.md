# 批量查询重试机制说明

## 更新日期
2026年2月7日

## 新功能特性

### 🔄 智能重试机制

批量查询现在具有三层重试保障：

#### 1️⃣ **即时重试（每个订单）**
- 每个订单查询失败后，自动重试 **2次**
- 每次重试间隔 **1秒**
- 重试过程在控制台输出日志

**示例流程：**
```
订单1: 查询 → 失败 → 重试1 → 失败 → 重试2 → 成功 ✅
订单2: 查询 → 成功 ✅
订单3: 查询 → 失败 → 重试1 → 失败 → 重试2 → 失败 ❌
```

#### 2️⃣ **批量处理**
- 仍然支持多线程并发查询
- 每个线程内的订单都有独立的重试机制
- 不会因为单个订单失败而影响其他订单

#### 3️⃣ **二次完整重试（所有失败订单）**
- 第一轮查询完成后，自动识别所有失败的订单
- 对失败的订单进行第二轮完整查询
- 第二轮中每个订单同样有 **2次重试机会**

**完整流程：**
```
第一轮：查询所有订单（每个订单最多重试2次）
   ↓
统计失败订单
   ↓
第二轮：重新查询失败的订单（每个订单最多重试2次）
   ↓
显示最终结果
```

## 使用方法

### 1. 访问批量查询页面
http://localhost:8080/query

### 2. 输入订单链接
每行一个订单链接：
```
https://www.apple.com/xc/us/vieworder/W1234567890/email1@example.com
https://www.apple.com/xc/us/vieworder/W0987654321/email2@example.com
https://www.apple.com/xc/us/vieworder/W1111111111/email3@example.com
```

### 3. 设置参数
- **并发线程数**：建议 5-10（根据网络情况调整）
- **超时时间**：建议 30-60 秒

### 4. 点击"开始查询"

### 5. 观察查询过程
- 进度条显示整体进度
- 状态栏显示当前查询情况
- 失败的订单会自动重试

## 状态显示

### 查询中
```
正在查询 50/100
速度: 3.5 个/秒
```

### 第一轮完成后（如有失败）
```
第一轮完成，重试 15 个失败的订单...
```

### 最终结果
```
查询完成，共 100 条，成功 95 条，失败 5 条，耗时 45.3 秒
```

## 重试逻辑详解

### 单个订单的重试次数
每个订单最多查询 **3次**（1次初始 + 2次重试）

### 失败订单的总重试次数
如果第一轮失败，第二轮会再次尝试：
- 第一轮：最多 3 次（1 + 2）
- 第二轮：最多 3 次（1 + 2）
- **总计：最多 6 次查询机会**

### 重试间隔
- 每次重试前等待 **1秒**
- 避免频繁请求被服务器拒绝

## 适用场景

### ✅ 推荐使用场景
1. **网络不稳定**时批量查询
2. **大批量订单**查询（100+）
3. **苹果服务器响应慢**时
4. **需要高成功率**的场景

### 📊 效果对比

| 场景 | 无重试 | 有重试 |
|------|--------|--------|
| 100个订单，10%失败率 | 成功90个 | 成功95-98个 |
| 网络波动 | 成功率70% | 成功率90%+ |
| 查询速度 | 快 | 稍慢（因为重试） |

## 控制台日志

打开浏览器控制台（F12）可以看到详细日志：

```javascript
订单 W1234567890 查询失败，重试 1/2...
订单 W1234567890 查询失败，重试 2/2...
第一轮完成，重试 15 个失败的订单...
重试失败订单 1/15...
重试失败订单 2/15...
...
```

## 性能优化建议

### 1. 调整并发数
- 网络好：可设置 10-20 线程
- 网络差：建议 5 线程
- 服务器限制：建议 3-5 线程

### 2. 调整超时时间
- 网络快：30 秒
- 网络慢：60 秒
- 特殊情况：90 秒

### 3. 分批查询
- 超过 500 个订单，建议分批查询
- 每批 100-200 个订单

## 注意事项

⚠️ **重要提示：**

1. **重试会增加总时间**
   - 每次重试增加约 1 秒
   - 失败订单多时，总时间会明显增加

2. **不要频繁查询同一订单**
   - 重试机制已经很充分
   - 避免被苹果服务器限制

3. **查看控制台日志**
   - 了解重试详情
   - 判断失败原因

4. **网络问题**
   - 如果大量失败，检查网络连接
   - 考虑使用 VPN 或更换网络

## 技术实现

### 核心函数
```javascript
async function queryOrderWithRetry(url, timeout, maxRetries = 2) {
    // 最多重试 2 次
    for (let attempt = 0; attempt <= maxRetries; attempt++) {
        // 尝试查询
        // 如果成功，立即返回
        // 如果失败，等待 1 秒后重试
    }
    // 返回最后的结果
}
```

### 工作流程
1. 第一轮查询所有订单
2. 每个订单失败后自动重试 2 次
3. 统计失败的订单
4. 第二轮重新查询失败的订单
5. 显示最终结果

## 更新历史

- **2026-02-07**: 添加智能重试机制
  - 单订单即时重试 2 次
  - 失败订单二次完整重试
  - 优化状态显示
  - 添加重试日志

---

📝 如有问题或建议，请及时反馈！
